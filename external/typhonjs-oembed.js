class e{static getDisableFilePoster(e){return e.getParam("oembed_disable_file_poster",!1)}static getDisableFileSource(e){return e.getParam("oembed_disable_file_source",!1)}static getMediaHeight(e){return e.getParam("oembed_default_height",288)}static getMediaWidth(e){return e.getParam("oembed_default_width",512)}static getUrlResolver(e){return e.getParam("oembed_url_resolver")}static hasDimensions(e){return e.getParam("oembed_dimensions",!0)}static hasLiveEmbeds(e){return e.getParam("oembed_live_embeds",!0)}static hasPoster(e){return e.getParam("oembed_poster",!0)}static shouldFilterHtml(e){return e.getParam("oembed_filter_html",!0)}}const t=(t,r)=>{if(!1===e.shouldFilterHtml(t))return r;const o=tinymce.html.Writer();let a;return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,comment:e=>{a||o.comment(e)},cdata:e=>{a||o.cdata(e)},text:(e,t)=>{a||o.text(e,t)},start:(e,r,n)=>{if(a=!0,"script"!==e&&"noscript"!==e&&"svg"!==e){for(let o=r.length-1;o>=0;o--){const a=r[o].name;0===a.indexOf("on")&&(delete r.map[a],r.splice(o,1)),"style"===a&&(r[o].value=t.dom.serializeStyle(t.dom.parseStyle(r[o].value),e))}o.start(e,r,n),a=!1}},end:e=>{a||o.end(e)}},tinymce.html.Schema({})).parse(r),o.getContent()};let r;class o{static placeHolderConverter(t){return r=>{let o,s=r.length;for(;s--;)o=r[s],o.parent&&!o.parent.attr("data-mce-object")&&(i(o)&&e.hasLiveEmbeds(t)?l(o)||o.replace(a(t,o)):l(o)||o.replace(n(t,o)))}}static setPoster(e){r=e}}const a=(e,t)=>{const o=t.name;void 0!==r&&t.attr("data-oembed-poster",r);const a=new tinymce.html.Node("span",1);a.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":o,class:`mce-preview-object mce-object-${o}`}),m(e,t,a);const n=e.dom.parseStyle(t.attr("style")),s=new tinymce.html.Node(o,1);if(d(t,s,n),s.attr({src:t.attr("src"),style:t.attr("style"),class:t.attr("class")}),"iframe"===o)s.attr({allowfullscreen:t.attr("allowfullscreen"),frameborder:"0"});else{const r=["controls","crossorigin","currentTime","loop","muted","poster","preload"];for(const e of r)s.attr(e,t.attr(e));const n=a.attr("data-mce-html");null!=n&&((e,t,r,o)=>{const a=tinymce.html.DomParser({forced_root_block:!1,validate:!1},e.schema).parse(o,{context:t});for(;a.firstChild;)r.append(a.firstChild)})(e,o,s,n)}const i=new tinymce.html.Node("span",1);return i.attr("class","mce-shim"),a.append(s),a.append(i),a},n=(e,t)=>{const o=t.name;void 0!==r&&t.attr("data-oembed-poster",r);const a=new tinymce.html.Node("img",1);a.shortEnded=!0,m(e,t,a);const n=t.attr("data-oembed-poster");return d(t,a,{}),a.attr({style:t.attr("style"),src:n||"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","data-mce-object":o,class:`mce-object mce-object-${o}`}),a},s=(e,t,r,o=null)=>{const a=e.attr(r);return null!=a?a:Object.hasOwnProperty.call(t,r)?null:o},i=e=>{const t=e.name;return"iframe"===t||"video"===t||"audio"===t},c=e=>{const t=e.attr("class");return t&&/\btiny-pageembed\b/.test(t)},l=e=>{for(;e=e.parent;)if(c(e))return!0;return!1},m=(e,r,o)=>{const a=r.attributes;let n=a.length;for(;n--;){const t=a[n].name;let r=a[n].value;"width"!==t&&"height"!==t&&"style"!==t&&("data"!==t&&"src"!==t||(r=e.convertURL(r,t)),o.attr(`data-oembed-p-${t}`,r))}const s=r.firstChild&&r.firstChild.value;s&&(o.attr("data-mce-html",escape(t(e,s))),o.firstChild=null)},d=(e,t,r)=>{const o="img"===t.name||"video"===e.name,a=o?"300":null,n="audio"===e.name?"30":"150",i=o?n:null;t.attr({width:s(e,r,"width",a),height:s(e,r,"height",i)})},u=["allowfullscreen","mozallowfullscreen","webkitallowfullscreen"],h=["audio","iframe","object","video"],p=(e,t)=>{const r=Object.keys(t);for(let o=0,a=r.length;o<a;o++){const a=r[o],n=`${t[a]}`;if(e.map[a]){let t=e.length;for(;t--;){const r=e[t];r.name===a&&(n?(e.map[a]=n,r.value=n):(delete e.map[a],e.splice(t,1)))}}else n&&(e.push({name:a,value:n}),e.map[a]=n)}},b=["source"],g=(e,t,r)=>{const o=tinymce.html.Writer();let a,n=0;return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,comment:e=>{o.comment(e)},cdata:e=>{o.cdata(e)},text:(e,t)=>{o.text(e,t)},start:(e,s,i)=>{switch(e){case"video":case"object":case"embed":case"img":case"iframe":void 0!==t.height&&void 0!==t.width&&p(s,{width:t.width,height:t.height})}if(r)switch(e){case"video":p(s,{poster:t.poster,src:""});break;case"iframe":p(s,{src:t.source});break;case"source":if(n<2&&(p(s,{src:t[b[n]],type:t[`${b[n]}mime`]}),!t[b[n]]))return;n++;break;case"img":if(!t.poster)return;a=!0}o.start(e,s,i)},end:e=>{if("video"===e&&r)for(let e=0;e<2;e++)if(t[b[e]]){const r=[];r.map={},n<=e&&(p(r,{src:t[b[e]],type:t[`${b[e]}mime`]}),o.start("source",r,!0))}if(t.poster&&"object"===e&&r&&!a){const e=[];e.map={},p(e,{src:t.poster,width:t.width,height:t.height}),o.start("img",e,!0)}o.end(e)}},tinymce.html.Schema({})).parse(e),o.getContent()},f=(e,t)=>r=>e.selection.selectorChangedWithUnbind(t.join(","),r.setActive).unbind;var y,v,w,A=function(e){return function(){return e}},j=A(!1),x=A(!0),O=function(){return _},_=(y=function(e){return e.isNone()},{fold:function(e,t){return e()},is:j,isSome:j,isNone:x,getOr:w=function(e){return e},getOrThunk:v=function(e){return e()},getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:A(null),getOrUndefined:A(void 0),or:w,orThunk:v,map:O,each:function(){},bind:O,exists:j,forall:x,filter:O,equals:y,equals_:y,toArray:function(){return[]},toString:A("none()")}),C=function(e){var t=A(e),r=function(){return a},o=function(t){return t(e)},a={fold:function(t,r){return r(e)},is:function(t){return e===t},isSome:x,isNone:j,getOr:t,getOrThunk:t,getOrDie:t,getOrNull:t,getOrUndefined:t,or:r,orThunk:r,map:function(t){return C(t(e))},each:function(t){t(e)},bind:o,exists:o,forall:o,filter:function(t){return t(e)?a:_},toArray:function(){return[e]},toString:function(){return"some("+e+")"},equals:function(t){return t.is(e)},equals_:function(t,r){return t.fold(j,(function(t){return r(e,t)}))}};return a},P={some:C,none:O,from:function(e){return null==e?_:C(e)}},D=Object.hasOwnProperty,S=function(e,t){return M(e,t)?P.from(e[t]):P.none()},M=function(e,t){return D.call(e,t)};const k=e=>{let t={};return tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,start:(e,r)=>{t.source||"param"!==e||(t.source=r.map.movie),"iframe"!==e&&"object"!==e&&"embed"!==e&&"video"!==e&&"audio"!==e||(t.type||(t.type=e),t=Object.assign({},r.map,t)),"source"===e&&(t.source||(t.source=r.map.src)),"img"!==e||t.poster||(t.poster=r.map.src),void 0!==r.map["data-oembed-poster"]&&(t.poster=r.map["data-oembed-poster"])}}).parse(e),t.source=t.source||t.src||t.data,t.poster=t.poster||"",t},$=new Map,E=[{name:"Vimeo",regex:/^(https:\/\/vimeo.com\/(.*)|https:\/\/vimeo.com\/album\/(.*)\/video\/(.*)|https:\/\/vimeo.com\/channels\/(.*)\/(.*)|https:\/\/vimeo.com\/groups\/(.*)\/videos\/(.*)|https:\/\/vimeo.com\/ondemand\/(.*)\/(.*)|https:\/\/player.vimeo.com\/video\/(.*))/,url:(e,t,r)=>`https://vimeo.com/api/oembed.json?url=${e}&maxwidth=${t}&maxheight=${r}`},{name:"YouTube",regex:/^(https:\/\/(.*).youtube.com\/watch(.*)|https:\/\/(.*).youtube.com\/v\/(.*)|https:\/\/youtu.be\/(.*)|https:\/\/(.*).youtube.com\/playlist?list=(.*))/,url:(e,t,r)=>`https://www.youtube.com/oembed?url=${e}&format=json&maxwidth=${t}&maxheight=${r}`}];class N{static async getEmbedHtml(t,r){let o;if($.has(r.source))return $.get(r.source);const a=e.getUrlResolver(t);if(a)try{const e=await a({url:r.source});o={url:r.source,html:e.html,poster:e.poster}}catch(e){const r=e.msg||e.message||"Unknown error.";return void t.notificationManager.open({type:"error",text:`Media embed error: ${r}`})}else{let a,n;const s=e.getMediaWidth(t),i=e.getMediaHeight(t);for(const e of E)e.regex.exec(r.source)&&(n=e.url(r.source,s,i),a=e.name);if(void 0===n)return void t.notificationManager.open({type:"error",text:"Media embed error: URL did not match any providers available."});const c=await window.fetch(n);if(!c||200!==c.status)return void t.notificationManager.open({type:"error",text:`Media embed error: Could not fetch ${a} embed URL.`});const l=await c.json();if(void 0===l.html){const e=l.error?l.error:`Could not fetch ${a} embed URL.`;return void t.notificationManager.open({type:"error",text:`Media embed error: ${e}`})}o={url:r.source,html:l.html,poster:l.thumbnail_url}}return $.set(r.source,o),o}static isCached(e){return $.has(e)}}class T{static showDialog(t){const r=F(t);let o=r;const a=Y(r),n=e.getDisableFilePoster(t),s=e.getDisableFileSource(t),i=[];i.push({name:"source",type:"urlinput",filetype:s?void 0:"media",label:"Source"}),e.hasDimensions(t)&&i.push({type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:!0}),i.push({name:"poster",type:"urlinput",filetype:n?void 0:"image",label:"Media poster (Image URL)"}),i.push({name:"embed",type:"textarea",label:"Generated Embed:",disabled:!0});const c={type:"panel",items:i};t.windowManager.open({title:"Insert/Edit Media (oEmbed)",size:"normal",body:c,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:async e=>{const r=T.unwrap(e.getData());await V(o,r,t),e.close()},onChange:async(e,r)=>{try{switch(r.name){case"source":await I(o,e,t);break;case"embed":B(e,t);break;case"dimensions":case"poster":W(e,r.name)}o=T.unwrap(e.getData())}catch(e){console.log(e)}},initialData:a},void 0)}static unwrap(e,t){const r=t?H(t,e).getOr({}):{},o=L(e,r,t);return{...o("source"),...o("poster"),...o("embed"),...z(e,r)}}}const R=["width","height"],U=(e,t,r)=>{if("string"==typeof e.url&&e.url.trim().length>0){const o=e.html,a={...Q(r,o),source:e.url,embed:o,poster:e.poster};t.setData(Y(a))}},H=(e,t)=>S(t,e).bind((e=>S(e,"meta"))),z=(e,t)=>{const r={};return S(e,"dimensions").each((e=>{for(const o of R)S(t,o).orThunk((()=>S(e,o))).each((e=>r[o]=e))})),r},F=e=>{const t=e.selection.getNode(),r=G(t)?e.serializer.serialize(t,{selection:!0}):"";return{embed:r,...k(r)}},L=(e,t,r)=>o=>{const a=()=>S(e,o),n=()=>S(t,o),s=e=>S(e,"value").bind((e=>e.length>0?P.some(e):P.none()));return{[o]:(o===r?a().bind((e=>"object"==typeof e?s(e).orThunk(n):n().orThunk((()=>P.from(e))))):n().orThunk((()=>a().bind((e=>"object"==typeof e?s(e):P.from(e)))))).getOr("")}},I=async(e,t,r)=>{const o=T.unwrap(t.getData(),"source");if(e.source!==o.source){U({url:o.source,html:"",poster:""},t,r);const e=await N.getEmbedHtml(r,o);e&&U(e,t,r)}},B=(e,t)=>{const r=T.unwrap(e.getData()),o=Q(t,r.embed);e.setData(Y(o))},W=(e,t)=>{const r=T.unwrap(e.getData(),t),o=r.embed?g(r.embed,r,!1):"";e.setData(Y({...r,embed:o}))},q=(e,t,r)=>{const a=e.dom.select("*[data-mce-object]");o.setPoster(r.poster),e.insertContent(t),o.setPoster(void 0),J(e,a).dataset.oembedPoster=r.poster,e.nodeChanged()},G=e=>e.getAttribute("data-mce-object"),J=(e,t)=>{const r=e.dom.select("*[data-mce-object]");for(let e=0;e<t.length;e++)for(let o=r.length-1;o>=0;o--)t[e]===r[o]&&r.splice(o,1);return e.selection.select(r[0]),r[0]},Q=(e,t)=>k(t),V=async(e,t,r)=>{if(t.embed=g(t.embed,t),t.embed&&(e.source===t.source||N.isCached(t.source)))q(r,t.embed,t);else{const e=await N.getEmbedHtml(r,t);e&&q(r,e.html,t)}},Y=e=>{const t={...e,source:{value:S(e,"source").getOr("")},poster:{value:S(e,"poster").getOr("")}};for(const r of R)S(e,r).each((e=>{const o=t.dimensions||{};o[r]=e,t.dimensions=o}));return t};tinymce.PluginManager.add("typhonjs-oembed",class{constructor(e){e.addCommand("typhonjsOembed",(()=>T.showDialog(e))),class{static register(e){e.ui.registry.addToggleButton("typhonjs-oembed",{tooltip:"Insert/edit media",icon:"embed",onAction:()=>{e.execCommand("typhonjsOembed")},onSetup:f(e,["img[data-mce-object]","span[data-mce-object]"])}),e.ui.registry.addMenuItem("typhonjs-oembed",{icon:"embed",text:"Media...",onAction:()=>{e.execCommand("typhonjsOembed")}})}}.register(e),class{static setup(e){e.on("ResolveName",(e=>{let t;1===e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}))}}.setup(e),class{static setup(e){e.on("preInit",(()=>{const r=e.schema.getSpecialElements();for(const e of h)r[e]=new RegExp(`</${e}[^>]*>`,"gi");const a=e.schema.getBoolAttrs();for(const e of u)a[e]={};e.parser.addNodeFilter("iframe,video,audio,object,embed",o.placeHolderConverter(e)),e.serializer.addAttributeFilter("data-mce-object",((r,o)=>{let a,n,s,i,c,l,m,d,u=r.length;for(;u--;)if(a=r[u],a.parent){for(m=a.attr(o),n=new tinymce.html.Node(m,1),"audio"!==m&&(d=a.attr("class"),d&&-1!==d.indexOf("mce-preview-object")?n.attr({width:a.firstChild.attr("width"),height:a.firstChild.attr("height")}):n.attr({width:a.attr("width"),height:a.attr("height")})),n.attr({style:a.attr("style")}),i=a.attributes,s=i.length;s--;){const e=i[s].name;0===e.indexOf("data-oembed-p-")&&n.attr(e.substr(14),i[s].value)}c=a.attr("data-mce-html"),c&&(l=new tinymce.html.Node("#text",3),l.raw=!0,l.value=t(e,unescape(c)),n.append(l)),a.replace(n)}}))}))}}.setup(e),class{static setup(e){e.on("click keyup touchend",(()=>{const t=e.selection.getNode();t&&e.dom.hasClass(t,"mce-preview-object")&&e.dom.getAttrib(t,"data-mce-selected")&&t.setAttribute("data-mce-selected","2")})),e.on("ObjectSelected",(e=>{"script"===e.target.getAttribute("data-mce-object")&&e.preventDefault()})),e.on("ObjectResized",(e=>{const t=e.target;let r;t.getAttribute("data-mce-object")&&(r=t.getAttribute("data-mce-html"),r&&(r=unescape(r),t.setAttribute("data-mce-html",escape(g(r,{width:String(e.width),height:String(e.height)})))))}))}}.setup(e)}getMetadata(){return{name:"TyphonJS oEmbed",url:"https://github.com/typhonjs-tinymce/oembed"}}});
//# sourceMappingURL=typhonjs-oembed.js.map
