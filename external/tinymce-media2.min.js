/**
 * Copyright (c) Tiny Technologies, Inc. All rights reserved.
 * Licensed under the LGPL or a commercial license.
 * For LGPL see License.txt in the project root for license information.
 * For commercial licenses see https://www.tiny.cloud/
 *
 * Version: 5.9.0 (TBD)
 */
!function(){"use strict";var e=tinymce.util.Tools.resolve("tinymce.PluginManager"),p=function(){return(p=Object.assign||function p(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function t(e,t,c,u){return new(c=c||Promise)(function(n,r){function a(e){try{i(u.next(e))}catch(t){r(t)}}function o(e){try{i(u["throw"](e))}catch(t){r(t)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(a,o)}i((u=u.apply(e,t||[])).next())})}function r(n,r){var a,o,i,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),"throw":t(1),"return":t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return u([t,e])}}function u(e){if(a)throw new TypeError("Generator is already executing.");for(;c;)try{if(a=1,o&&(i=2&e[0]?o["return"]:e[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,e[1])).done)return i;switch(o=0,(e=i?[2&e[0],i.value]:e)[0]){case 0:case 1:i=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,o=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(i=0<(i=c.trys).length&&i[i.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!i||e[1]>i[0]&&e[1]<i[3])){c.label=e[1];break}if(6===e[0]&&c.label<i[1]){c.label=i[1],i=e;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(e);break}i[2]&&c.ops.pop(),c.trys.pop();continue}e=r.call(n,c)}catch(t){e=[6,t],o=0}finally{a=i=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}var n,u,a=function(r){return function(e){return n=typeof(t=e),(null===t?"null":"object"==n&&(Array.prototype.isPrototypeOf(t)||t.constructor&&"Array"===t.constructor.name)?"array":"object"==n&&(String.prototype.isPrototypeOf(t)||t.constructor&&"String"===t.constructor.name)?"string":n)===r;var t,n}},o=a("string"),s=a("object"),l=a("array"),m=function(e){return!(null===(t=e)||t===undefined);var t},i=function(e){return function(){return e}},c=function(e){return e},d=i(!1),f=i(!0),h=function(){return g},g={fold:function(e,t){return e()},isSome:d,isNone:f,getOr:c,getOrThunk:n=function(e){return e()},getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:i(null),getOrUndefined:i(undefined),or:c,orThunk:n,map:h,each:function(){},bind:h,exists:d,forall:f,filter:function(){return g},toArray:function(){return[]},toString:i("none()")},b=function(n){var e=i(n),t=function(){return a},r=function(e){return e(n)},a={fold:function(e,t){return t(n)},isSome:f,isNone:d,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:t,orThunk:t,map:function(e){return b(e(n))},each:function(e){e(n)},bind:r,exists:r,forall:r,filter:function(e){return e(n)?a:g},toArray:function(){return[n]},toString:function(){return"some("+n+")"}};return a},v={some:b,none:h,from:function(e){return null===e||e===undefined?g:b(e)}},y=Array.prototype.push,w=function(e,t){for(var n=0,r=e.length;n<r;n++)t(e[n],n)},x=function(e){var t=e;return{get:function(){return t},set:function(e){t=e}}},j=Object.keys,O=Object.hasOwnProperty,S=function(e,t){return T(e,t)?v.from(e[t]):v.none()},T=function(e,t){return O.call(e,t)},_=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),k=tinymce.util.Tools.resolve("tinymce.html.SaxParser"),C=tinymce.util.Tools.resolve("tinymce.util.Tools"),A=_.DOM,P=function(e){return e.replace(/px$/,"")},D=function(e){var o=x(!1),i={};return k({validate:!1,allow_conditional_comments:!0,start:function(e,t){var n,r,a;o.get()||(T(t.map,"data-ephox-embed-iri")?(o.set(!0),r=(n=t).map.style,a=r?A.parseStyle(r):{},i={type:"ephox-embed-iri",source:n.map["data-ephox-embed-iri"],poster:"",width:S(a,"max-width").map(P).getOr(""),height:S(a,"max-height").map(P).getOr("")}):(i.source||"param"!==e||(i.source=t.map.movie),"iframe"!==e&&"object"!==e&&"embed"!==e&&"video"!==e&&"audio"!==e||(i.type||(i.type=e),i=C.extend(t.map,i)),"source"===e&&(i.source||(i.source=t.map.src)),"img"!==e||i.poster||(i.poster=t.map.src)))}}).parse(e),i.source=i.source||i.src||i.data,i.poster=i.poster||"",i},M=tinymce.util.Tools.resolve("tinymce.Env"),z=tinymce.util.Tools.resolve("tinymce.html.DomParser"),E=tinymce.util.Tools.resolve("tinymce.html.Node"),N=tinymce.util.Tools.resolve("tinymce.html.Schema"),U=tinymce.util.Tools.resolve("tinymce.html.Writer"),R=function(o,e){if(!1===o.getParam("media_filter_html",!0))return e;var i,c=U();return k({validate:!1,allow_conditional_comments:!1,comment:function(e){i||c.comment(e)},cdata:function(e){i||c.cdata(e)},text:function(e,t){i||c.text(e,t)},start:function(e,t,n){if(i=!0,"script"!==e&&"noscript"!==e&&"svg"!==e){for(var r=t.length-1;0<=r;r--){var a=t[r].name;0===a.indexOf("on")&&(delete t.map[a],t.splice(r,1)),"style"===a&&(t[r].value=o.dom.serializeStyle(o.dom.parseStyle(t[r].value),e))}c.start(e,t,n),i=!1}},end:function(e){i||c.end(e)}},N({})).parse(e),c.getContent()},I=function(e,t,n,r){void 0===r&&(r=null);var a=e.attr(n);return m(a)?a:T(t,n)?null:r},L=function(e,t,n){var r="img"===t.name||"video"===e.name,a="audio"===e.name?"30":"150",o=r?a:null;t.attr({width:I(e,n,"width",r?"300":null),height:I(e,n,"height",o)})},$=function(e,t){var n=t.name;void 0!==u&&t.attr("data-typhonjs-poster",u);var r=new E("span",1);r.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":n,"class":"mce-preview-object mce-object-"+n}),F(e,t,r);var a,o=e.dom.parseStyle(t.attr("style")),i=new E(n,1);L(t,i,o),i.attr({src:t.attr("src"),style:t.attr("style"),"class":t.attr("class")}),"iframe"===n?i.attr({allowfullscreen:t.attr("allowfullscreen"),frameborder:"0"}):(w(["controls","crossorigin","currentTime","loop","muted","poster","preload"],function(e){i.attr(e,t.attr(e))}),a=r.attr("data-mce-html"),m(a)&&function(e,t,n,r){for(var a=z({forced_root_block:!1,validate:!1},e.schema).parse(r,{context:t});a.firstChild;)n.append(a.firstChild)}(e,n,i,a));var c=new E("span",1);return c.attr("class","mce-shim"),r.append(i),r.append(c),r},F=function(e,t,n){for(var r=t.attributes,a=r.length;a--;){var o=r[a].name,i=r[a].value;"width"!==o&&"height"!==o&&"style"!==o&&("data"!==o&&"src"!==o||(i=e.convertURL(i,o)),n.attr("data-mce-p-"+o,i))}var c=t.firstChild&&t.firstChild.value;c&&(n.attr("data-mce-html",escape(R(e,c))),n.firstChild=null)},B=function(e){for(;e=e.parent;)if(e.attr("data-ephox-embed-iri")||(t=void 0,(t=e.attr("class"))&&/\btiny-pageembed\b/.test(t)))return!0;var t;return!1},W=function(a){return function(e){for(var t,n,r=e.length;r--;)(t=e[r]).parent&&(t.parent.attr("data-mce-object")||(n=void 0,("iframe"===(n=t.name)||"video"===n||"audio"===n)&&a.getParam("media_live_embeds",!0)&&M.ceFalse?B(t)||t.replace($(a,t)):B(t)||t.replace(function(e,t){var n=t.name;void 0!==u&&t.attr("data-typhonjs-poster",u);var r=new E("img",1);r.shortEnded=!0,F(e,t,r);var a=t.attr("data-typhonjs-poster");return L(t,r,{}),r.attr({style:t.attr("style"),src:a||M.transparentSrc,"data-mce-object":n,"class":"mce-object mce-object-"+n}),r}(a,t))))}},Y=function(e){u=e},G=tinymce.util.Tools.resolve("tinymce.util.Promise"),q={},H=/^(https:\/\/youtu\.be|https:\/\/youtube.com)/,J=function(s,l){return t(void 0,void 0,void 0,function(){var t,n,o,i,c,u;return r(this,function(e){switch(e.label){case 0:return(t=s.getParam("media_url_resolver"))?[4,(r=l,a=t,new G(function(t,e){var n=function(e){return e.html&&(q[r.source]=e),t({url:r.source,html:e.html})};q[r.source]?n(q[r.source]):a({url:r.source},n,e)}))]:[3,2];case 1:return n=e.sent(),[3,5];case 2:if(!H.exec(l.source))throw{msg:"Only YouTube video URLs are accepted."};return o=s.getParam("media_width",512),i=s.getParam("media_height",288),[4,window.fetch("https://www.youtube.com/oembed?url="+l.source+"&format=json&maxwidth="+o+"&maxheight="+i)];case 3:if(!(c=e.sent())||200!==c.status)throw{msg:"Could not fetch YouTube embed URL."};return[4,c.json()];case 4:u=e.sent(),n={html:u.html,poster:u.thumbnail_url,url:l.source},e.label=5;case 5:return[2,n]}var r,a})})},K=_.DOM,Q=function(e){return/^[0-9.]+$/.test(e)?e+"px":e},V=function(o,e){!function(e,t){for(var n=j(e),r=0,a=n.length;r<a;r++){var o=n[r];t(e[o],o)}}(e,function(e,t){var n=""+e;if(o.map[t])for(var r=o.length;r--;){var a=o[r];a.name===t&&(n?(o.map[t]=n,a.value=n):(delete o.map[t],o.splice(r,1)))}else n&&(o.push({name:t,value:n}),o.map[t]=n)})},X=["source"],Z=function(e,c,u){var s,l=U(),m=x(!1),d=0;return k({validate:!1,allow_conditional_comments:!0,comment:function(e){l.comment(e)},cdata:function(e){l.cdata(e)},text:function(e,t){l.text(e,t)},start:function(e,t,n){if(!m.get())if(T(t.map,"data-ephox-embed-iri"))m.set(!0),r=c,o=(a=t).map.style,(i=o?K.parseStyle(o):{})["max-width"]=Q(r.width),i["max-height"]=Q(r.height),V(a,{style:K.serializeStyle(i)});else{switch(e){case"video":case"object":case"embed":case"img":case"iframe":c.height!==undefined&&c.width!==undefined&&V(t,{width:c.width,height:c.height})}if(u)switch(e){case"video":V(t,{poster:c.poster,src:""});break;case"iframe":V(t,{src:c.source});break;case"source":if(d<2&&(V(t,{src:c[X[d]],type:c[X[d]+"mime"]}),!c[X[d]]))return;d++;break;case"img":if(!c.poster)return;s=!0}}var r,a,o,i;l.start(e,t,n)},end:function(e){if(!m.get()){if("video"===e&&u)for(var t,n=0;n<2;n++)c[X[n]]&&((t=[]).map={},d<=n&&(V(t,{src:c[X[n]],type:c[X[n]+"mime"]}),l.start("source",t,!0)));var r;c.poster&&"object"===e&&u&&!s&&((r=[]).map={},V(r,{src:c.poster,width:c.width,height:c.height}),l.start("img",r,!0))}l.end(e)}},N({})).parse(e),l.getContent()},ee=function(e,t){var o,i,c,n,r,a=t?S(e,t).bind(function(e){return S(e,"meta")}).getOr({}):{},u=(o=e,i=a,c=t,function(e){var t=function(){return S(o,e)},n=function(){return S(i,e)},r=function(e){return S(e,"value").bind(function(e){return 0<e.length?v.some(e):v.none()})},a={};return a[e]=(e===c?t().bind(function(e){return s(e)?r(e).orThunk(n):n().orThunk(function(){return v.from(e)})}):n().orThunk(function(){return t().bind(function(e){return s(e)?r(e):v.from(e)})})).getOr(""),a});return p(p(p(p({},u("source")),u("poster")),u("embed")),(n=a,r={},S(e,"dimensions").each(function(e){w(["width","height"],function(t){S(n,t).orThunk(function(){return S(e,t)}).each(function(e){return r[t]=e})})}),r))},te=function(e){var r=p(p({},e),{source:{value:S(e,"source").getOr("")},poster:{value:S(e,"poster").getOr("")}});return w(["width","height"],function(n){S(e,n).each(function(e){var t=r.dimensions||{};t[n]=e,r.dimensions=t})}),r},ne=function(n){return function(e){var t=e&&e.msg?"Media embed handler error: "+e.msg:"Media embed handler threw unknown error.";n.notificationManager.open({type:"error",text:t})}},re=function(e,t){return D(t)},ae=function(a,e){return function(e){var t,n,r;o(e.url)&&0<e.url.trim().length&&(t=e.html,n=re(0,t),r=p(p({},n),{source:e.url,embed:t,poster:e.poster}),a.setData(te(r)))}},oe=function(e,t,n){var r=e.dom.select("*[data-mce-object]");Y(n.poster),e.insertContent(t),Y(void 0),function(e,t){for(var n=e.dom.select("*[data-mce-object]"),r=0;r<t.length;r++)for(var a=n.length-1;0<=a;a--)t[r]===n[a]&&n.splice(a,1);return e.selection.select(n[0]),n[0]}(e,r).dataset.typhonjsPoster=n.poster,e.nodeChanged()},ie=function(e,t,n){var r;t.embed=Z(t.embed,t),t.embed&&(e.source===t.source||(r=t.source,T(q,r)))?oe(n,t.embed,t):J(n,t).then(function(e){oe(n,e.html,t)})["catch"](ne(n))},ce=function(m){var e,t,n,r,a=(n=(e=m).selection.getNode(),r=(t=n).getAttribute("data-mce-object")||t.getAttribute("data-ephox-embed-iri")?e.serializer.serialize(n,{selection:!0}):"",p({embed:r},D(r))),d=x(a),o=te(a),i=m.getParam("media_disable_file_poster",!1),c=function(e){for(var t=[],n=0,r=e.length;n<r;++n){if(!l(e[n]))throw new Error("Arr.flatten item "+n+" was not an array, input: "+e);y.apply(t,e[n])}return t}([[m.getParam("media_disable_file_source",!1)?{name:"source",type:"urlinput",label:"Source"}:{name:"source",type:"urlinput",filetype:"media",label:"Source"}],m.getParam("media_dimensions",!0)?[{type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:!0}]:[],[i?{name:"poster",type:"urlinput",label:"Media poster (Image URL)"}:{name:"poster",type:"urlinput",filetype:"image",label:"Media poster (Image URL)"}],[{name:"embed",type:"textarea",label:"Paste your embed code below:"}]]),f=m.windowManager.open({title:"Insert/Edit Media",size:"normal",body:{type:"panel",items:c},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:function(e){var t=ee(e.getData());ie(d.get(),t,m),e.close()},onChange:function(e,t){switch(t.name){case"source":s=d.get(),l=ee(e.getData(),"source"),s.source!==l.source&&(ae(f)({url:l.source,html:"",poster:""}),J(m,l).then(ae(f))["catch"](ne(m)));break;case"embed":c=ee((i=e).getData()),u=re(0,c.embed),i.setData(te(u));break;case"dimensions":case"poster":n=e,r=t.name,a=ee(n.getData(),r),o=a.embed?Z(a.embed,a,!1):"",n.setData(te(p(p({},a),{embed:o})))}var n,r,a,o,i,c,u,s,l;d.set(ee(e.getData()))},initialData:o})};e.add("media2",function(e){var t,n,r,a,d,o,i;return(t=e).addCommand("mceMedia2",function(){ce(t)}),(n=e).ui.registry.addToggleButton("media2",{tooltip:"Insert/edit media",icon:"embed",onAction:function(){n.execCommand("mceMedia2")},onSetup:(r=n,a=["img[data-mce-object]","span[data-mce-object]","div[data-ephox-embed-iri]"],function(e){return r.selection.selectorChangedWithUnbind(a.join(","),e.setActive).unbind})}),n.ui.registry.addMenuItem("media2",{icon:"embed",text:"Media...",onAction:function(){n.execCommand("mceMedia2")}}),e.on("ResolveName",function(e){var t;1===e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}),(d=e).on("preInit",function(){var t=d.schema.getSpecialElements();C.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});var n=d.schema.getBoolAttrs();C.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){n[e]={}}),d.parser.addNodeFilter("iframe,video,audio,object,embed,script",W(d)),d.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var n,r,a,o,i,c,u,s,l=e.length;l--;)if((n=e[l]).parent){for(u=n.attr(t),r=new E(u,1),"audio"!==u&&"script"!==u&&((s=n.attr("class"))&&-1!==s.indexOf("mce-preview-object")?r.attr({width:n.firstChild.attr("width"),height:n.firstChild.attr("height")}):r.attr({width:n.attr("width"),height:n.attr("height")})),r.attr({style:n.attr("style")}),a=(o=n.attributes).length;a--;){var m=o[a].name;0===m.indexOf("data-mce-p-")&&r.attr(m.substr(11),o[a].value)}"script"===u&&r.attr("type","text/javascript"),(i=n.attr("data-mce-html"))&&((c=new E("#text",3)).raw=!0,c.value=R(d,unescape(i)),r.append(c)),n.replace(r)}})}),d.on("SetContent",function(){d.$("span.mce-preview-object").each(function(e,t){var n=d.$(t);0===n.find("span.mce-shim").length&&n.append('<span class="mce-shim"></span>')})}),(o=e).on("click keyup touchend",function(){var e=o.selection.getNode();e&&o.dom.hasClass(e,"mce-preview-object")&&o.dom.getAttrib(e,"data-mce-selected")&&e.setAttribute("data-mce-selected","2")}),o.on("ObjectSelected",function(e){"script"===e.target.getAttribute("data-mce-object")&&e.preventDefault()}),o.on("ObjectResized",function(e){var t,n=e.target;n.getAttribute("data-mce-object")&&(t=n.getAttribute("data-mce-html"))&&(t=unescape(t),n.setAttribute("data-mce-html",escape(Z(t,{width:String(e.width),height:String(e.height)}))))}),i=e,{showDialog:function(){ce(i)}}})}();